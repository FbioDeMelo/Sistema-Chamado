<h2 style="margin-bottom:15px; color:#2563eb;">Chat do Chamado: {{ ticket.titulo }}</h2>

<div id="chat-box" style="
       border:1px solid #ccc;
    padding:15px;
    height:400px;
    overflow-y:auto;
    background:#f4f6f8;
    border-radius:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    scrollbar-width: none;
        -ms-overflow-style: none;"
        >
    <!-- mensagens carregadas via Ajax -->
</div>

<form id="form-chat" style="
    margin-top:10px;
    display:flex;
    gap:10px;
    align-items:flex-end;
">
    <textarea id="texto-mensagem" placeholder="Digite sua mensagem..." required
        style="
            flex:1;
            padding:12px;
            border-radius:8px;
            border:1px solid #ccc;
            font-size:0.95rem;
            resize:none;
        "></textarea>
    <button type="submit" style="
        padding:12px 20px;
        border:none;
        background:#2563eb;
        color:white;
        border-radius:8px;
        cursor:pointer;
        font-weight:500;
        transition: background 0.3s;
    " onmouseover="this.style.background='#1d4ed8';" onmouseout="this.style.background='#2563eb';">
        Enviar
    </button>
</form>


<script>
const ticketId = {{ ticket.id }};
const chatBox = document.getElementById('chat-box');
const form = document.getElementById('form-chat');
const textarea = document.getElementById('texto-mensagem');

function carregarMensagens() {
    fetch(`/chat/${ticketId}/`)
        .then(res => res.json())
        .then(data => {
            chatBox.innerHTML = '';
            data.mensagens.forEach(m => {
                const p = document.createElement('div');
                const isAutor = m.autor === '{{ request.user.username }}';
                p.style.marginBottom = '8px';
                p.style.padding = '8px 12px';
                p.style.borderRadius = '15px';
                p.style.maxWidth = '70%';
                p.style.background = isAutor ? '#DCF8C6' : '#FFF';
                p.style.alignSelf = isAutor ? 'flex-end' : 'flex-start';
                p.style.clear = 'both';
                p.style.display = 'inline-block';
                p.innerHTML = `<strong>${m.autor}:</strong> ${m.texto}<br><span style="font-size:0.7em;color:gray;">${m.data_envio}</span>`;
                chatBox.appendChild(p);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        });
}

// Atualiza mensagens a cada 2 segundos
setInterval(carregarMensagens, 2000);
carregarMensagens();

// Envio via Ajax
form.addEventListener('submit', e => {
    e.preventDefault();
    const formData = new FormData();
    formData.append('texto', textarea.value);

    fetch(`/chat/${ticketId}/`, {
        method: 'POST',
        headers: {'X-CSRFToken': '{{ csrf_token }}'},
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.sucesso) {
            textarea.value = '';
            carregarMensagens();
        }
    });
});
</script>
